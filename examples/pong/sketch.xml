<_>
    <canvas width="window_width" height="window_height" background="0" left_paddle="null"
        right_paddle="null" left_score="0" right_score="0" count_down="120" wait_time="120"
        state="'start'" winner="''" fill="255" ball_speed_mag="canvas.height/100"
        default_ball_speed_mag="canvas.height/100" game="this_element">
        <!-- SCORE -->
        <text content="left_score" x="canvas.width * 0.3" y="canvas.height * 0.1"
            fill="255"
            text_size="canvas.height/10" text_align="CENTER, TOP">
            <text content="right_score" x="canvas.width - x"></text>
        </text>

        <!-- GAME OBJECTS -->
        <paddle x="canvas.width * 0.1" up="87" down="83"></paddle>
        <paddle left_paddle="above_sibling" right_paddle="this_element">
            <ball on="count_down LESS_THAN 1"></ball>
        </paddle>


        <!-- STATE MANAGEMENT -->
        <_ x="canvas.width/2" y="canvas.height/2" text_align="CENTER, CENTER"
            text_size="canvas.height/15"> <!-- TODO - fix newline -->
            <text on="state === 'start'"
                content="'Left: W for up, S for down\nRight: up/down arrows\n\nClick to start'">
                <_ on="mouse_down" game.state="'play'"></_>
            </text>
            <text
                on="above_siblings_off AND state === 'pause'" content="'Paused'">
                <_ on="mouse_down" game.state="'play'"></_>
            </text>
            <_
                on="above_siblings_off AND state === 'play'" game.count_down="count_down - 1">
                <_ on="mouse_down" game.state="'pause'"></_>
            </_>
            <text
                on="above_siblings_off AND state === 'gameover'"
                content="winner + ' wins!\n Click to play again!'">
                <_ on="mouse_down" game.state="'play'" game.left_score="0" game.right_score="0"></_>
            </text>
        </_>
    </canvas>
    <!-- BALL -->
    <custom name="ball" s="canvas.height/50" stroke="NONE" fill="255" rect_mode="CENTER"
        speed="createVector()" ball="this_element">
        <!-- POSITION CHECKS -->
        <_ ball_left="x - s/2" ball_right="x + s/2" ball_top="y - s/2" ball_bottom="y + s/2"
            moving_left="speed.x LESS_THAN 0">
            <!-- RESET -->
            <_ on="count_down === 0" random_angle="random(HALF_PI) - QUARTER_PI + random([0, PI])"
                ball.x="canvas.width/2" ball.y="canvas.height/2" ball.reset="false"
                ball_speed_mag="default_ball_speed_mag">
                <_ ball.speed="p5.Vector.fromAngle(random_angle, ball_speed_mag)"></_>
            </_>
            <!-- TOP BOTTOM BOUNCE -->
            <_
                on="above_siblings_off AND ball_top LESS_THAN 0 || ball_bottom GREATER_THAN canvas.height"
                ball.speed.y="-ball.speed.y"></_>
            <!-- LEFT COLLISION/SCORE CHECK -->
            <_ on="above_siblings_off AND moving_left"
                left_hit="ball_left LESS_THAN left_paddle.x + left_paddle.width/2">
                <_ on="left_hit"
                    right_hit="ball_right GREATER_THAN left_paddle.x - left_paddle.width/2"
                    paddle_top="left_paddle.y - left_paddle.height/2">
                    <!-- RIGHT SCORE -->
                    <_ on="ball_left LESS_THAN 0">
                        <_ on="count_down LESS_THAN 0" game.count_down="120"
                            game.right_score="right_score + 1">
                            <_ on="game.right_score === 7"
                                game.state="'gameover'"
                                game.winner="'Right'"></_>
                        </_>
                    </_>
                    <!-- LEFT PADDLE HIT -->
                    <_ on="above_siblings_off AND right_hit"
                        bottom_hit="ball_bottom GREATER_THAN paddle_top"
                        paddle_bottom="left_paddle.y + left_paddle.height/2">
                        <_ on="bottom_hit" top_hit="ball_top LESS_THAN paddle_bottom">
                            <_ on="top_hit">
                                <_ ball.speed.x="-ball.speed.x"
                                    ball.speed.y="(y - left_paddle.y)/20"
                                    ball_speed_mag="ball_speed_mag * 1.1"></_>
                                <_ ball.speed="ball.speed.normalize().mult(ball_speed_mag)"></_>
                            </_>
                        </_>
                    </_>
                </_>
            </_>
            <!--  RIGHT COLLISION/SCORE -->
            <_ on="above_siblings_off" right_hit="ball_right GREATER_THAN right_paddle.x">
                <_ on="right_hit" left_hit="ball_left LESS_THAN right_paddle.x + right_paddle.width"
                    paddle_top="right_paddle.y - right_paddle.height/2">
                    <!-- LEFT SCORE -->
                    <_ on="ball_right GREATER_THAN canvas.width">
                        <_ on="count_down LESS_THAN 0" game.count_down="120"
                            game.left_score="left_score + 1">
                            <_ on="game.left_score === 7" game.state="'gameover'"
                                game.winner="'Left'"></_>
                        </_>
                    </_>
                    <!-- RIGHT PADDLE HIT -->
                    <_ on="above_siblings_off AND left_hit"
                        top_hit="ball_bottom GREATER_THAN paddle_top"
                        paddle_bottom="right_paddle.y + right_paddle.height/2">
                        <_ on="top_hit" bottom_hit="ball_top LESS_THAN paddle_bottom">
                            <_ on="bottom_hit">
                                <_ ball.speed.x="-ball.speed.x"
                                    ball.speed.y=" (y - right_paddle.y)/20"
                                    ball_speed_mag="ball_speed_mag * 1.1"></_>
                                <_ ball.speed=" ball.speed.normalize().mult(ball_speed_mag)"></_>
                            </_>
                        </_>
                    </_>
                </_>
            </_>
        </_>
        <_ on="game.state === 'play'" ball.x="ball.x + speed.x" ball.y="ball.y + speed.y"
            ball_left="x - w/2" ball_right="x + w/2"></_>
        <square></square>
    </custom>
    <!-- PADDLE -->
    <custom name="paddle" x="canvas.width * 0.9" y="canvas.height/2"
        width="canvas.height/50" height="canvas.height/5"
        stroke="NONE" fill="255" rect_mode="CENTER" up=" UP_ARROW" down="DOWN_ARROW"
        speed="canvas.height/75" paddle=" this_element">
        <!-- MOVEMENT -->
        <_ on="key_is_down(up)" paddle.y="constrain(paddle.y - speed, h/2, canvas.height - h/2)"></_>
        <_ on="key_is_down(down)" paddle.y="constrain(paddle.y + speed, h/2, canvas.height - h/2)"></_>
        <rect></rect>
    </custom>
</_>